# esp-ir-center-and-relays
esp8266/8285 IR universal reciever/sender with HTTP GET actions

Прибор предназначен для централизации управления умным домом с любого ИК-пульта, одновременно интегрируясь с другими устройствами и сервисами, поддерживающими обмен по HTTP GET запросам. Устройство оснащено WiFI Manager [https://www.arduino.cc/reference/en/libraries/wifimanager/], что позволяет легко подключаться к существующим сетям 2.4Ггц. Если установленная сеть недоступна, устройство запускает точку доступа, подключившись к которой можно настроить подключение к нужной сети. Поддерживается обширный список протоколов, благодаря библиотеке IR Remote [https://github.com/Arduino-IRremote/Arduino-IRremote].

Прототип запущен на ESP M3 модуле, но должен работать и на обычных esp8266 модулях. Необходимое условие - наличие SPIFFS, для хранения конфиг-файлов команд.

![alt text](https://github.com/whoim2/esp-ir-center-and-relays/raw/main/photo_2022-09-16_18-12-19.jpg)

 Алгоритмы работы. Все крутится вокруг понятия "команда", число их задается #define CMD_SIZE. У каждой команды есть событие для ее старта (event) и действия (actions).
Для начала исполнения команды необходимо обучить поле event нужной кнопке пульта. Навести пульт на устройство, нажать кнопку, затем в веб-интерфейсе перед нужным полем event нажать кнопку read. Поле должно заполнится строкой вида HEXNUMBER,PROTOCOL,BITS. Поле заполняется последней полученной устройством ИК-последовательностью. При наличии проблем можно наблюдать вывод дебаг в serial.
Также команда запускается , если запросить любым сервисом или браузером соответствующую ссылку, которая пишется под именем команды в заголовке, вида http://192.168.1.200?cmd=0.

Полей actions у каждой команды четыре - два для ИК-передатчика, и два для механизма HTTP GET. Доступно два режима команды - Linear и Trigger. В первом последовательно выполняются первые и вторые команды ИК и HTTP GET, возможно установить паузу в миллисекундах между выполнениями. В режиме Trigger команды выполняются по очереди - при первом вызове первые actions, при втором - вторые, далее по кругу.
Если какое либо поле actions пустое, данное действие выполнятся не будет. ИК-поля, если их очистить и сохранить, принимают вид 0,UNUSED,0; это нормально. Необходимо сохранять каждую команду отдельно, кнопкой SAVE под каждой командой. Работать она начинает сразу после сохранения.

В приведенном ниже примере CMD 0 в режиме триггера управляет другой esp m3 с реле на борту, включая и выключая розетку с лампой. CMD 1 работает аналогично, включая и выключая розетку с блоком питания. CMD 2 в Linear посылает два сигнала включения проектора, будучи обучена с его пульта, с задержкой между ними. Это не мешает включению и нужно для выключения - проектор после первого ИК-сигнала просит подтвердить выключение вторым таким же.

![alt text](https://github.com/whoim2/esp-ir-center-and-relays/raw/main/Screenshot_2.png)

Платы esp прошиваются через arduino ide с ядром esp8266, используемые библиотеки приложены. Также приложу bin для прошивки без компиляции.

В каталоге relay4ch лежит прошивка для esp с четырмя реле, управляемыми по http get. Первые две CMD на скрине выше работают именно с ним.

Вопросы лучше задавать в телеграм-чатике https://t.me/savelylive
